apiVersion: v1
kind: ServiceAccount
metadata:
  name: airbyte-admin
  namespace: application
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: airbyte-admin-role
  namespace: application
rules:
- apiGroups:
  - '*'
  resources:
  - jobs
  - pods
  - pods/log
  - pods/exec
  - pods/attach
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: airbyte-admin-binding
  namespace: application
roleRef:
  apiGroup: ""
  kind: Role
  name: airbyte-admin-role
subjects:
- kind: ServiceAccount
  name: airbyte-admin
  namespace: application
---
apiVersion: v1
data:
  AIRBYTE_VERSION: 0.27.2-alpha
  API_URL: /api/v1/
  AWS_ACCESS_KEY_ID: minio
  AWS_SECRET_ACCESS_KEY: minio123
  CONFIG_ROOT: /configs
  DATA_DOCKER_MOUNT: airbyte_data
  DATABASE_DB: airbyte
  DATABASE_HOST: airbyte-db-svc
  DATABASE_PASSWORD: docker
  DATABASE_PORT: "5432"
  DATABASE_URL: jdbc:postgresql://airbyte-db-svc:5432/airbyte
  DATABASE_USER: docker
  DB_DOCKER_MOUNT: airbyte_db
  FULLSTORY: enabled
  GCP_STORAGE_BUCKET: ""
  GOOGLE_APPLICATION_CREDENTIALS: ""
  INTERNAL_API_HOST: airbyte-server-svc:8001
  IS_DEMO: "false"
  LOCAL_ROOT: /tmp/airbyte_local
  LOG_LEVEL: INFO
  PAPERCUPS_STORYTIME: enabled
  RESOURCE_CPU_LIMIT: ""
  RESOURCE_CPU_REQUEST: ""
  RESOURCE_MEMORY_LIMIT: ""
  RESOURCE_MEMORY_REQUEST: ""
  S3_LOG_BUCKET: airbyte-dev-logs
  S3_LOG_BUCKET_REGION: us-east-1
  S3_MINIO_ENDPOINT: http://airbyte-minio-svc:9000
  S3_PATH_STYLE_ACCESS: "true"
  TEMPORAL_HOST: airbyte-temporal-svc:7233
  TEMPORAL_WORKER_PORTS: 9001,9002,9003,9004,9005,9006,9007,9008,9009,9010,9011,9012,9013,9014,9015,9016,9017,9018,9019,9020,9021,9022,9023,9024,9025,9026,9027,9028,9029,9030
  TRACKING_STRATEGY: segment
  WEBAPP_URL: airbyte-webapp-svc:80
  WORKER_ENVIRONMENT: kubernetes
  WORKSPACE_DOCKER_MOUNT: airbyte_workspace
  WORKSPACE_ROOT: /workspace
kind: ConfigMap
metadata:
  name: airbyte-env-825hc6dmgf
  namespace: application
---
apiVersion: v1
data:
  development.yaml: |
    # when modifying, remember to update the docker-compose version of this file in temporal/dynamicconfig/development.yaml
    frontend.enableClientVersionCheck:
      - value: true
        constraints: {}
    history.persistenceMaxQPS:
      - value: 3000
        constraints: {}
    frontend.persistenceMaxQPS:
      - value: 3000
        constraints: {}
    frontend.historyMgrNumConns:
      - value: 30
        constraints: {}
    frontend.throttledLogRPS:
      - value: 20
        constraints: {}
    history.historyMgrNumConns:
      - value: 50
        constraints: {}
    system.advancedVisibilityWritingMode:
      - value: "off"
        constraints: {}
    history.defaultActivityRetryPolicy:
      - value:
          InitialIntervalInSeconds: 1
          MaximumIntervalCoefficient: 100.0
          BackoffCoefficient: 2.0
          MaximumAttempts: 0
    history.defaultWorkflowRetryPolicy:
      - value:
          InitialIntervalInSeconds: 1
          MaximumIntervalCoefficient: 100.0
          BackoffCoefficient: 2.0
          MaximumAttempts: 0
    # Limit for responses. This mostly impacts discovery jobs since they have the largest responses.
    limit.blobSize.error:
      - value: 15728640 # 15MB
        constraints: {}
    limit.blobSize.warn:
      - value: 10485760 # 10MB
        constraints: {}
kind: ConfigMap
metadata:
  name: airbyte-temporal-dynamicconfig
  namespace: application
---
apiVersion: v1
data:
  sweep-pod.sh: |
    #!/bin/bash
    get_worker_pods () {
      kubectl -n ${KUBE_NAMESPACE} -L airbyte -l airbyte=worker-pod --field-selector status.phase!=Running get pods -o go-template --template '{{range .items}} {{.metadata.name}} {{.status.phase}} {{.metadata.creationTimestamp}}{{"\n"}}{{end}}'
    }
    delete_worker_pod() {
      printf "From status '%s' since '%s', " $2 $3
      echo "$1" | grep -v "STATUS" | awk '{print $1}' | xargs --no-run-if-empty kubectl -n ${KUBE_NAMESPACE} delete pod
    }
    while :
    do
      # Shorter time window for completed pods
      SUCCESS_DATE_STR=`date -d 'now - 30 seconds' --utc -Ins`
      SUCCESS_DATE=`date -d $SUCCESS_DATE_STR +%s`
      # Longer time window for pods in error (to debug)
      NON_SUCCESS_DATE_STR=`date -d 'now - 24 hours' --utc -Ins`
      NON_SUCCESS_DATE=`date -d $NON_SUCCESS_DATE_STR +%s`
      (
          IFS=$'\n'
          for POD in `get_worker_pods`; do
              IFS=' '
              POD_NAME=`echo $POD | cut -d " " -f 1`
              POD_STATUS=`echo $POD | cut -d " " -f 2`
              POD_DATE_STR=`echo $POD | cut -d " " -f 3`
              POD_DATE=`date -d $POD_DATE_STR '+%s'`
              if [ "$POD_STATUS" = "Succeeded" ]; then
                if [ "$POD_DATE" -lt "$SUCCESS_DATE" ]; then
                  delete_worker_pod "$POD_NAME" "$POD_STATUS" "$POD_DATE_STR"
                fi
              else
                if [ "$POD_DATE" -lt "$NON_SUCCESS_DATE" ]; then
                  delete_worker_pod "$POD_NAME" "$POD_STATUS" "$POD_DATE_STR"
                fi
              fi
          done
      )
      sleep 60
    done
kind: ConfigMap
metadata:
  name: sweep-pod-script
  namespace: application
---
apiVersion: v1
data:
  gcp.json: ""
kind: Secret
metadata:
  name: gcs-log-creds
  namespace: application
---
apiVersion: v1
kind: Service
metadata:
  name: airbyte-db-svc
  namespace: application
spec:
  ports:
  - port: 5432
    protocol: TCP
  selector:
    airbyte: db
  type: NodePort
---
apiVersion: v1
kind: Service
metadata:
  name: airbyte-minio-svc
  namespace: application
spec:
  ports:
  - port: 9000
    protocol: TCP
    targetPort: 9000
  selector:
    app: airbyte-minio
---
apiVersion: v1
kind: Service
metadata:
  name: airbyte-server-svc
  namespace: application
spec:
  ports:
  - port: 8001
    protocol: TCP
  selector:
    airbyte: server
  type: NodePort
---
apiVersion: v1
kind: Service
metadata:
  name: airbyte-temporal-svc
  namespace: application
spec:
  ports:
  - port: 7233
    protocol: TCP
  selector:
    airbyte: temporal
  type: NodePort
---
apiVersion: v1
kind: Service
metadata:
  name: airbyte-webapp-svc
  namespace: application
spec:
  ports:
  - port: 80
    protocol: TCP
  selector:
    airbyte: webapp
  type: NodePort
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    app: airbyte-minio-storage-claim
  name: airbyte-minio-pv-claim
  namespace: application
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 200Mi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    airbyte: volume-configs
  name: airbyte-volume-configs
  namespace: application
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 500Mi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    airbyte: volume-db
  name: airbyte-volume-db
  namespace: application
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 500Mi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    airbyte: volume-workspace
  name: airbyte-volume-workspace
  namespace: application
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 500Mi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: airbyte-db
  namespace: application
spec:
  replicas: 1
  selector:
    matchLabels:
      airbyte: db
  template:
    metadata:
      labels:
        airbyte: db
    spec:
      containers:
      - env:
        - name: POSTGRES_DB
          value: db-airbyte
        - name: POSTGRES_PASSWORD
          value: docker
        - name: POSTGRES_USER
          value: docker
        - name: PGDATA
          value: /var/lib/postgresql/data/pgdata
        image: katonic/airbyte-db:0.27.2-alpha
        name: airbyte-db-container
        ports:
        - containerPort: 5432
        volumeMounts:
        - mountPath: /var/lib/postgresql/data
          name: airbyte-volume-db
      volumes:
      - name: airbyte-volume-db
        persistentVolumeClaim:
          claimName: airbyte-volume-db
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: airbyte-minio
  namespace: application
spec:
  selector:
    matchLabels:
      app: airbyte-minio
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: airbyte-minio
    spec:
      containers:
      - args:
        - server
        - /storage
        env:
        - name: MINIO_ACCESS_KEY
          value: minio
        - name: MINIO_SECRET_KEY
          value: minio123
        image: katonic/minio-minio:latest
        name: airbyte-minio
        ports:
        - containerPort: 9000
          hostPort: 9000
        volumeMounts:
        - mountPath: /storage
          name: storage
      volumes:
      - name: storage
        persistentVolumeClaim:
          claimName: airbyte-minio-pv-claim
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: airbyte-pod-sweeper
  namespace: application
spec:
  replicas: 1
  selector:
    matchLabels:
      airbyte: pod-sweeper
  template:
    metadata:
      labels:
        airbyte: pod-sweeper
    spec:
      containers:
      - command:
        - /bin/bash
        - -c
        - /script/sweep-pod.sh
        env:
        - name: KUBE_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        image: katonic/bitnami-kubectl:latest
        imagePullPolicy: IfNotPresent
        name: airbyte-pod-sweeper
        volumeMounts:
        - mountPath: /script/sweep-pod.sh
          name: sweep-pod-script
          subPath: sweep-pod.sh
      volumes:
      - configMap:
          defaultMode: 493
          name: sweep-pod-script
        name: sweep-pod-script
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: airbyte-scheduler
  namespace: application
spec:
  replicas: 1
  selector:
    matchLabels:
      airbyte: scheduler
  template:
    metadata:
      labels:
        airbyte: scheduler
    spec:
      automountServiceAccountToken: true
      containers:
      - env:
        - name: AIRBYTE_VERSION
          valueFrom:
            configMapKeyRef:
              key: AIRBYTE_VERSION
              name: airbyte-env-825hc6dmgf
        - name: CONFIG_ROOT
          valueFrom:
            configMapKeyRef:
              key: CONFIG_ROOT
              name: airbyte-env-825hc6dmgf
        - name: DATABASE_HOST
          valueFrom:
            configMapKeyRef:
              key: DATABASE_HOST
              name: airbyte-env-825hc6dmgf
        - name: DATABASE_PORT
          valueFrom:
            configMapKeyRef:
              key: DATABASE_PORT
              name: airbyte-env-825hc6dmgf
        - name: DATABASE_PASSWORD
          valueFrom:
            configMapKeyRef:
              key: DATABASE_PASSWORD
              name: airbyte-env-825hc6dmgf
        - name: DATABASE_URL
          valueFrom:
            configMapKeyRef:
              key: DATABASE_URL
              name: airbyte-env-825hc6dmgf
        - name: DATABASE_USER
          valueFrom:
            configMapKeyRef:
              key: DATABASE_USER
              name: airbyte-env-825hc6dmgf
        - name: TRACKING_STRATEGY
          valueFrom:
            configMapKeyRef:
              key: TRACKING_STRATEGY
              name: airbyte-env-825hc6dmgf
        - name: WORKSPACE_DOCKER_MOUNT
          value: workspace
        - name: WORKSPACE_ROOT
          valueFrom:
            configMapKeyRef:
              key: WORKSPACE_ROOT
              name: airbyte-env-825hc6dmgf
        - name: WORKER_ENVIRONMENT
          valueFrom:
            configMapKeyRef:
              key: WORKER_ENVIRONMENT
              name: airbyte-env-825hc6dmgf
        - name: LOCAL_ROOT
          valueFrom:
            configMapKeyRef:
              key: LOCAL_ROOT
              name: airbyte-env-825hc6dmgf
        - name: WEBAPP_URL
          valueFrom:
            configMapKeyRef:
              key: WEBAPP_URL
              name: airbyte-env-825hc6dmgf
        - name: TEMPORAL_HOST
          valueFrom:
            configMapKeyRef:
              key: TEMPORAL_HOST
              name: airbyte-env-825hc6dmgf
        - name: TEMPORAL_WORKER_PORTS
          valueFrom:
            configMapKeyRef:
              key: TEMPORAL_WORKER_PORTS
              name: airbyte-env-825hc6dmgf
        - name: LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              key: LOG_LEVEL
              name: airbyte-env-825hc6dmgf
        - name: KUBE_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: RESOURCE_CPU_REQUEST
          valueFrom:
            configMapKeyRef:
              key: RESOURCE_CPU_REQUEST
              name: airbyte-env-825hc6dmgf
        - name: RESOURCE_CPU_LIMIT
          valueFrom:
            configMapKeyRef:
              key: RESOURCE_CPU_LIMIT
              name: airbyte-env-825hc6dmgf
        - name: RESOURCE_MEMORY_REQUEST
          valueFrom:
            configMapKeyRef:
              key: RESOURCE_MEMORY_REQUEST
              name: airbyte-env-825hc6dmgf
        - name: RESOURCE_MEMORY_LIMIT
          valueFrom:
            configMapKeyRef:
              key: RESOURCE_MEMORY_LIMIT
              name: airbyte-env-825hc6dmgf
        - name: S3_LOG_BUCKET
          valueFrom:
            configMapKeyRef:
              key: S3_LOG_BUCKET
              name: airbyte-env-825hc6dmgf
        - name: S3_LOG_BUCKET_REGION
          valueFrom:
            configMapKeyRef:
              key: S3_LOG_BUCKET_REGION
              name: airbyte-env-825hc6dmgf
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            configMapKeyRef:
              key: AWS_ACCESS_KEY_ID
              name: airbyte-env-825hc6dmgf
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            configMapKeyRef:
              key: AWS_SECRET_ACCESS_KEY
              name: airbyte-env-825hc6dmgf
        - name: S3_MINIO_ENDPOINT
          valueFrom:
            configMapKeyRef:
              key: S3_MINIO_ENDPOINT
              name: airbyte-env-825hc6dmgf
        - name: S3_PATH_STYLE_ACCESS
          valueFrom:
            configMapKeyRef:
              key: S3_PATH_STYLE_ACCESS
              name: airbyte-env-825hc6dmgf
        - name: GOOGLE_APPLICATION_CREDENTIALS
          valueFrom:
            configMapKeyRef:
              key: GOOGLE_APPLICATION_CREDENTIALS
              name: airbyte-env-825hc6dmgf
        - name: GCP_STORAGE_BUCKET
          valueFrom:
            configMapKeyRef:
              key: GCP_STORAGE_BUCKET
              name: airbyte-env-825hc6dmgf
        image: katonic/airbyte-scheduler:0.27.2-alpha
        name: airbyte-scheduler-container
        ports:
        - containerPort: 9000
        - containerPort: 9001
        - containerPort: 9002
        - containerPort: 9003
        - containerPort: 9004
        - containerPort: 9005
        - containerPort: 9006
        - containerPort: 9007
        - containerPort: 9008
        - containerPort: 9009
        - containerPort: 9010
        - containerPort: 9011
        - containerPort: 9012
        - containerPort: 9013
        - containerPort: 9014
        - containerPort: 9015
        - containerPort: 9016
        - containerPort: 9017
        - containerPort: 9018
        - containerPort: 9019
        - containerPort: 9020
        - containerPort: 9021
        - containerPort: 9022
        - containerPort: 9023
        - containerPort: 9024
        - containerPort: 9025
        - containerPort: 9026
        - containerPort: 9027
        - containerPort: 9028
        - containerPort: 9029
        - containerPort: 9030
        volumeMounts:
        - mountPath: /configs
          name: airbyte-volume-configs
        - mountPath: /workspace
          name: airbyte-volume-workspace
        - mountPath: /secrets/gcs-log-creds
          name: gcs-log-creds-volume
          readOnly: true
      initContainers:
      - args:
        - -c
        - mkdir -p /configs/config && yes n | cp -r -i /app/seed/config /configs
        command:
        - /bin/sh
        image: katonic/airbyte-seed:0.27.2-alpha
        name: airbyte-seed
        volumeMounts:
        - mountPath: /configs
          name: airbyte-volume-configs
        - mountPath: /workspace
          name: airbyte-volume-workspace
      serviceAccountName: airbyte-admin
      volumes:
      - name: airbyte-volume-workspace
        persistentVolumeClaim:
          claimName: airbyte-volume-workspace
      - name: airbyte-volume-configs
        persistentVolumeClaim:
          claimName: airbyte-volume-configs
      - name: gcs-log-creds-volume
        secret:
          secretName: gcs-log-creds
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: airbyte-server
  namespace: application
spec:
  replicas: 1
  selector:
    matchLabels:
      airbyte: server
  template:
    metadata:
      labels:
        airbyte: server
    spec:
      affinity:
        podAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: airbyte
                operator: In
                values:
                - scheduler
            topologyKey: kubernetes.io/hostname
      containers:
      - env:
        - name: AIRBYTE_VERSION
          valueFrom:
            configMapKeyRef:
              key: AIRBYTE_VERSION
              name: airbyte-env-825hc6dmgf
        - name: CONFIG_ROOT
          valueFrom:
            configMapKeyRef:
              key: CONFIG_ROOT
              name: airbyte-env-825hc6dmgf
        - name: DATABASE_PASSWORD
          valueFrom:
            configMapKeyRef:
              key: DATABASE_PASSWORD
              name: airbyte-env-825hc6dmgf
        - name: DATABASE_URL
          valueFrom:
            configMapKeyRef:
              key: DATABASE_URL
              name: airbyte-env-825hc6dmgf
        - name: DATABASE_USER
          valueFrom:
            configMapKeyRef:
              key: DATABASE_USER
              name: airbyte-env-825hc6dmgf
        - name: TRACKING_STRATEGY
          valueFrom:
            configMapKeyRef:
              key: TRACKING_STRATEGY
              name: airbyte-env-825hc6dmgf
        - name: WORKER_ENVIRONMENT
          valueFrom:
            configMapKeyRef:
              key: WORKER_ENVIRONMENT
              name: airbyte-env-825hc6dmgf
        - name: WORKSPACE_ROOT
          valueFrom:
            configMapKeyRef:
              key: WORKSPACE_ROOT
              name: airbyte-env-825hc6dmgf
        - name: WEBAPP_URL
          valueFrom:
            configMapKeyRef:
              key: WEBAPP_URL
              name: airbyte-env-825hc6dmgf
        - name: TEMPORAL_HOST
          valueFrom:
            configMapKeyRef:
              key: TEMPORAL_HOST
              name: airbyte-env-825hc6dmgf
        - name: LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              key: LOG_LEVEL
              name: airbyte-env-825hc6dmgf
        - name: RESOURCE_CPU_REQUEST
          valueFrom:
            configMapKeyRef:
              key: RESOURCE_CPU_REQUEST
              name: airbyte-env-825hc6dmgf
        - name: RESOURCE_CPU_LIMIT
          valueFrom:
            configMapKeyRef:
              key: RESOURCE_CPU_LIMIT
              name: airbyte-env-825hc6dmgf
        - name: RESOURCE_MEMORY_REQUEST
          valueFrom:
            configMapKeyRef:
              key: RESOURCE_MEMORY_REQUEST
              name: airbyte-env-825hc6dmgf
        - name: RESOURCE_MEMORY_LIMIT
          valueFrom:
            configMapKeyRef:
              key: RESOURCE_MEMORY_LIMIT
              name: airbyte-env-825hc6dmgf
        - name: S3_LOG_BUCKET
          valueFrom:
            configMapKeyRef:
              key: S3_LOG_BUCKET
              name: airbyte-env-825hc6dmgf
        - name: S3_LOG_BUCKET_REGION
          valueFrom:
            configMapKeyRef:
              key: S3_LOG_BUCKET_REGION
              name: airbyte-env-825hc6dmgf
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            configMapKeyRef:
              key: AWS_ACCESS_KEY_ID
              name: airbyte-env-825hc6dmgf
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            configMapKeyRef:
              key: AWS_SECRET_ACCESS_KEY
              name: airbyte-env-825hc6dmgf
        - name: S3_MINIO_ENDPOINT
          valueFrom:
            configMapKeyRef:
              key: S3_MINIO_ENDPOINT
              name: airbyte-env-825hc6dmgf
        - name: S3_PATH_STYLE_ACCESS
          valueFrom:
            configMapKeyRef:
              key: S3_PATH_STYLE_ACCESS
              name: airbyte-env-825hc6dmgf
        - name: GOOGLE_APPLICATION_CREDENTIALS
          valueFrom:
            configMapKeyRef:
              key: GOOGLE_APPLICATION_CREDENTIALS
              name: airbyte-env-825hc6dmgf
        - name: GCP_STORAGE_BUCKET
          valueFrom:
            configMapKeyRef:
              key: GCP_STORAGE_BUCKET
              name: airbyte-env-825hc6dmgf
        image: katonic/airbyte-server:0.27.2-alpha
        name: airbyte-server-container
        ports:
        - containerPort: 8001
        volumeMounts:
        - mountPath: /configs
          name: airbyte-volume-configs
        - mountPath: /workspace
          name: airbyte-volume-workspace
        - mountPath: /secrets/gcs-log-creds
          name: gcs-log-creds-volume
          readOnly: true
      volumes:
      - name: airbyte-volume-workspace
        persistentVolumeClaim:
          claimName: airbyte-volume-workspace
      - name: airbyte-volume-configs
        persistentVolumeClaim:
          claimName: airbyte-volume-configs
      - name: gcs-log-creds-volume
        secret:
          secretName: gcs-log-creds
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: airbyte-temporal
  namespace: application
spec:
  replicas: 1
  selector:
    matchLabels:
      airbyte: temporal
  template:
    metadata:
      labels:
        airbyte: temporal
    spec:
      containers:
      - env:
        - name: POSTGRES_USER
          valueFrom:
            configMapKeyRef:
              key: DATABASE_USER
              name: airbyte-env-825hc6dmgf
        - name: POSTGRES_PWD
          valueFrom:
            configMapKeyRef:
              key: DATABASE_PASSWORD
              name: airbyte-env-825hc6dmgf
        - name: DYNAMIC_CONFIG_FILE_PATH
          value: config/dynamicconfig/development.yaml
        - name: DB
          value: postgresql
        - name: DB_PORT
          valueFrom:
            configMapKeyRef:
              key: DATABASE_PORT
              name: airbyte-env-825hc6dmgf
        - name: POSTGRES_SEEDS
          valueFrom:
            configMapKeyRef:
              key: DATABASE_HOST
              name: airbyte-env-825hc6dmgf
        image: katonic/temporalio-auto-setup:1.7.0
        name: airbyte-temporal
        ports:
        - containerPort: 7233
        volumeMounts:
        - mountPath: /etc/temporal/config/dynamicconfig/
          name: airbyte-temporal-dynamicconfig
      volumes:
      - configMap:
          items:
          - key: development.yaml
            path: development.yaml
          name: airbyte-temporal-dynamicconfig
        name: airbyte-temporal-dynamicconfig
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: airbyte-webapp
  namespace: application
spec:
  replicas: 1
  selector:
    matchLabels:
      airbyte: webapp
  template:
    metadata:
      labels:
        airbyte: webapp
    spec:
      containers:
      - env:
        - name: AIRBYTE_VERSION
          valueFrom:
            configMapKeyRef:
              key: AIRBYTE_VERSION
              name: airbyte-env-825hc6dmgf
        - name: API_URL
          valueFrom:
            configMapKeyRef:
              key: API_URL
              name: airbyte-env-825hc6dmgf
        - name: TRACKING_STRATEGY
          valueFrom:
            configMapKeyRef:
              key: TRACKING_STRATEGY
              name: airbyte-env-825hc6dmgf
        - name: PAPERCUPS_STORYTIME
          valueFrom:
            configMapKeyRef:
              key: PAPERCUPS_STORYTIME
              name: airbyte-env-825hc6dmgf
        - name: FULLSTORY
          valueFrom:
            configMapKeyRef:
              key: FULLSTORY
              name: airbyte-env-825hc6dmgf
        - name: IS_DEMO
          valueFrom:
            configMapKeyRef:
              key: IS_DEMO
              name: airbyte-env-825hc6dmgf
        - name: INTERNAL_API_HOST
          valueFrom:
            configMapKeyRef:
              key: INTERNAL_API_HOST
              name: airbyte-env-825hc6dmgf
        image: katonic/trial:connectors-webapp
        name: airbyte-webapp-container
        ports:
        - containerPort: 80
        
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
 name: airbyte-vs
 namespace: application
spec:
  gateways:
  - kubeflow/kubeflow-gateway
  hosts:
  - change-external-ip
  http:
  - match:
    - uri:
        prefix: /airbyte
    rewrite:
      uri: /
    route:
    - destination:
        host: airbyte-webapp-svc.application.svc.cluster.local
        port:
          number: 80
  - match:
    - uri:
        prefix: /static
    - uri:
        regex: /images/.*\.(ico|png|jpg|svg|ttf|woff|woff2|css)$
    - uri:
        prefix: /api
    route:
    - destination:
        host: airbyte-webapp-svc.application.svc.cluster.local
        port:
          number: 80
